<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hasil Seleksi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @media print {
            nav, .no-print { display: none; }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans hidden" id="main-content">
    <nav class="bg-blue-600 shadow-md sticky top-0 z-50 mb-8">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <a href="dashboard.html" class="text-white text-xl font-bold flex items-center gap-2">
                    üéì SPK Beasiswa
                </a>
                
                <!-- Mobile Menu Button -->
                <div class="md:hidden">
                    <button onclick="toggleMenu()" class="text-white focus:outline-none hover:text-blue-200">
                        <svg class="h-6 w-6 fill-current" viewBox="0 0 24 24">
                            <path fill-rule="evenodd" d="M4 5h16a1 1 0 0 1 0 2H4a1 1 0 1 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2z"/>
                        </svg>
                    </button>
                </div>

                <!-- Desktop Menu -->
                <div class="hidden md:flex space-x-4 items-center">
                    <a href="dashboard.html" class="text-blue-100 hover:text-white transition font-medium flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        Dashboard
                    </a>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition shadow-md text-sm font-bold">Logout</button>
                </div>
            </div>

            <!-- Mobile Menu (Hidden by default) -->
            <div id="mobile-menu" class="hidden md:hidden mt-4 border-t border-blue-500 pt-4">
                <div class="flex flex-col space-y-3">
                    <a href="dashboard.html" class="block text-blue-100 hover:text-white transition py-2 px-2 rounded hover:bg-blue-700 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        Dashboard
                    </a>
                    <button onclick="logout()" class="w-full text-left bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition shadow mt-2">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-6">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-2xl font-bold text-gray-800 text-center md:text-left">Laporan Hasil Seleksi Beasiswa</h2>
                <div class="flex gap-2 no-print">
                    <button onclick="exportExcel()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 shadow">üìä Export Excel</button>
                    <button onclick="window.print()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 shadow">üñ®Ô∏è Cetak PDF</button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full leading-normal">
                    <thead>
                        <tr>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nama Siswa</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">N. Akademik (50%)</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">N. Potensi (20%)</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">N. Ekonomi (30%)</th>
                            <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Skor Akhir</th>
                        </tr>
                    </thead>
                    <tbody id="tabel-hasil">
                        <!-- Hasil dimuat JS -->
                    </tbody>
                </table>
            </div>
            
            <div class="mt-6 no-print">
                <a href="dashboard.html" class="text-blue-600 hover:underline">&larr; Kembali ke Dashboard</a>
            </div>
        </div>
    </div>

    <script src="supabase_config.js"></script>
    <script>
        if (!localStorage.getItem('session_admin')) window.location.href = 'login.html';
        document.getElementById('main-content').classList.remove('hidden');
        loadPerhitungan();

        async function loadPerhitungan() {
            // 1. Ambil Data Siswa & Config dari Supabase
            const { data: siswa } = await supabase.from('siswa').select('*');
            const { data: settingsData } = await supabase.from('settings').select('content').eq('name', 'kriteria_config').single();
            const config = JSON.parse(settingsData.content);

            // 2. Fungsi Hitung Bobot Gap
            function hitung_bobot_gap(gap) {
                const tabel = {
                    '0': 5, '1': 4.5, '-1': 4, '2': 3.5, '-2': 3,
                    '3': 2.5, '-3': 2, '4': 1.5, '-4': 1
                };
                return tabel[gap] || 1;
            }

            // 3. Proses Perhitungan
            let hasil = siswa.map(s => {
                let nilai_akhir = 0;
                let detail_aspek = {};

                for (const [nama_aspek, aspek] of Object.entries(config)) {
                    // Hitung Core Factor
                    let total_core = 0;
                    let count_core = 0;
                    for (const [kriteria, target] of Object.entries(aspek.core)) {
                        let gap = s[kriteria] - target;
                        total_core += hitung_bobot_gap(gap);
                        count_core++;
                    }
                    let ncf = total_core / count_core;

                    // Hitung Secondary Factor
                    let total_secondary = 0;
                    let count_secondary = 0;
                    for (const [kriteria, target] of Object.entries(aspek.secondary)) {
                        let gap = s[kriteria] - target;
                        total_secondary += hitung_bobot_gap(gap);
                        count_secondary++;
                    }
                    let nsf = total_secondary / count_secondary;

                    // Nilai Aspek & Akumulasi
                    let nilai_aspek = (ncf * 0.6) + (nsf * 0.4);
                    detail_aspek[nama_aspek] = nilai_aspek;
                    nilai_akhir += nilai_aspek * aspek.bobot;
                }

                s.nilai_aspek = detail_aspek;
                s.skor_akhir = nilai_akhir;
                return s;
            });

            // 4. Urutkan & Tampilkan
            hasil.sort((a, b) => b.skor_akhir - a.skor_akhir);

            const tbody = document.getElementById('tabel-hasil');
            
            hasil.forEach(row => {
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-5 py-5 border-b border-gray-200 text-sm font-medium">${row.nama}</td>
                        <td class="px-5 py-5 border-b border-gray-200 text-sm text-gray-700">${row.nilai_aspek.akademik.toFixed(2)}</td>
                        <td class="px-5 py-5 border-b border-gray-200 text-sm text-gray-700">${row.nilai_aspek.potensi.toFixed(2)}</td>
                        <td class="px-5 py-5 border-b border-gray-200 text-sm text-gray-700">${row.nilai_aspek.ekonomi.toFixed(2)}</td>
                        <td class="px-5 py-5 border-b border-gray-200 text-sm font-bold text-blue-600">${row.skor_akhir.toFixed(2)}</td>
                    </tr>`;
            });
        }
        async function logout() { 
            localStorage.removeItem('session_admin');
            window.location.href = 'login.html'; 
        }

        function exportExcel() {
            let table = document.querySelector("table");
            let html = encodeURIComponent(table.outerHTML);
            let a = document.createElement('a');
            a.href = 'data:application/vnd.ms-excel,' + html;
            a.download = 'Laporan_Seleksi.xls';
            a.click();
        }

        function toggleMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }
    </script>
</body>
</html>